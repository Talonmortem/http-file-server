<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .logout-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        .folder { font-weight: bold; cursor: pointer; }
        .back-btn, .download-btn { margin-bottom: 10px; }
        #drop-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-bottom: 20px; }

        #drag-indicator {
            position: absolute;
            display: none;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 10px;
            border-radius: 50%;
            font-size: 16px;
            width: 40px;
            height: 40px;
            text-align: center;
            line-height: 40px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>–§–∞–π–ª–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä</h1>
        <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
    
    <button class="back-btn" id="back-button" onclick="goUp()">‚¨Ü –ù–∞–∑–∞–¥</button>
    <button class="download-btn" onclick="downloadFiles()">‚¨á –°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    
    <div id="drop-area" ondrop="handleDrop(event)" ondragover="event.preventDefault()">
        –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
    </div>

    <form id="uploadForm" onsubmit="uploadFilesFromInput(event)" style="margin-bottom: 10px;" >
        –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
        <br>
        <input type="file" id="fileInput" multiple required>
        <button type="submit">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã</button>
    </form>
    <p id="uploadStatus"></p>

    <h3>        <span id="current-dir-name">/</span>   </h3>


    <button class="create-folder-btn" onclick="createFolder()">üìÅ –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
    <button class="delete-btn" onclick="deleteFiles()">üóë –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>


    <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫">
    <button onclick="searchFiles()">üîç</button>
    
    <table>
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all"></th>
                <th>–ò–º—è</th>
                <th>–†–∞–∑–º–µ—Ä</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</th>
                <th>–ó–∞–º–µ—Ç–∫–∏</th>
            </tr>
        </thead>
        <tbody id="file-list"></tbody>
    </table>

    <div id="drag-indicator">üìÇ</div>

    <script>
        let currentPath = "";
        let rootPath = "";
        let selectedFiles = [];
        const dragIndicator = document.getElementById("drag-indicator");

        async function fetchConfig() {
            try {
                const response = await fetch("/config");
                if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏");
                const data = await response.json();
                rootPath = data.rootPath;
                fetchFiles(rootPath);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:", error);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–µ—Ä–∞.");
            }
        }

        async function fetchFiles(path = "") {
            selectedFiles = [];
            currentPath = path;
            document.getElementById("current-dir-name").textContent = path || "/";
            document.getElementById("back-button").style.display = (path === "" || path === rootPath) ? "none" : "inline-block";
            
            const response = await fetch(`/files?path=${encodeURIComponent(path)}`);
            const data = await response.json();
            
            const fileList = document.getElementById("file-list");
            fileList.innerHTML = "";
            
            data.files.forEach(file => {
                const row = document.createElement("tr");
                row.draggable = true;
                row.ondragstart = (event) => dragStart(event, file.path);
                row.ondragover = file.is_dir ? (event) => event.preventDefault() : null;
                row.ondrop = file.is_dir ? (event) => dropFiles(event, file.path) : null;
                
                row.innerHTML = `
                    <td><input type="checkbox" value="${file.path}" onchange="toggleFileSelection(this)"></td>
                    <td class="${file.is_dir ? 'folder' : ''}" onclick="${file.is_dir ? `fetchFiles('${file.path}')` : ''}">
                        ${file.is_dir ? 'üìÅ' : 'üìÑ'} ${file.name}
                    </td>
                    <td>${file.size}</td>
                    <td>${file.modified}</td>
                    <td contenteditable="true" onblur="saveNote('${file.path}', this.innerText)">${file.notes || ''}</td>
                `;
                fileList.appendChild(row);
            });
        }

        function toggleSelectAll(checkbox) {
            selectedFiles = [];
            document.querySelectorAll("#file-list input[type='checkbox']").forEach(cb => {
                cb.checked = checkbox.checked;
                if (checkbox.checked) selectedFiles.push(cb.value);
            });
        }

        function toggleFileSelection(checkbox) {
            if (checkbox.checked) {
                selectedFiles.push(checkbox.value);
            } else {
                selectedFiles = selectedFiles.filter(file => file !== checkbox.value);
            }
        }

        function dragStart(event, filePath) {
            if (!selectedFiles.includes(filePath)) {
                selectedFiles = [filePath];
            }
            dragIndicator.textContent = `üìÇ ${selectedFiles.length}`;
            dragIndicator.style.display = "block";
            event.dataTransfer.setData("text/plain", JSON.stringify(selectedFiles));
        }

        function dropFiles(event, targetFolder) {
            event.preventDefault();
            dragIndicator.style.display = "none";
            const filesToMove = JSON.parse(event.dataTransfer.getData("text/plain"));
            
            const confirmMove = confirm(`–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å ${filesToMove.length} —Ñ–∞–π–ª(–∞) –≤ ${targetFolder}?`);
            if (!confirmMove) return;

            fetch("/move", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ files: filesToMove, destination: targetFolder })
                }).then(() => fetchFiles(currentPath));
        }

        function goUp() {
            if (!currentPath || currentPath === rootPath) return;
            const parentPath = currentPath.split("/").slice(0, -1).join("/");
            fetchFiles(parentPath);
        }

        async function downloadFiles() {
            const selectedFiles = Array.from(document.querySelectorAll("input[type='checkbox']:checked"))
                                      .map(cb => cb.value);
            if (selectedFiles.length === 0) return;
            
            const response = await fetch('/download-zip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: selectedFiles, currentDirName : currentPath })
            });
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = response.headers.get('Content-Disposition').split('filename=')[1];
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function deleteFiles() {
            const selectedFiles = Array.from(document.querySelectorAll("input[type='checkbox']:checked"))
                                      .map(cb => cb.value);
            if (selectedFiles.length === 0) return;
            
            const response = await fetch('/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: selectedFiles })
            });
            
            if (response.ok) {
                fetchFiles(currentPath);
            }
        }

        async function createFolder(path= "") {
            path = currentPath;
            const response = await fetch('/create-folder?path=' + encodeURIComponent(path), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path })
            });
            
            if (response.ok) {
                fetchFiles(currentPath);
            }
            
        }
        
        function handleDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            uploadFiles(files, currentPath);
        }
        
        async function uploadFiles(files, path = "") {
            path = currentPath;
            const formData = new FormData();
            formData.append('path', path);
            
            const filesArray = Array.from(files);
            for (let file of filesArray) {
                formData.append('files', file);
            }

            
            const response = await fetch('/upload?path=' + encodeURIComponent(path), {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                fetchFiles(path);
            }
        }

        async function uploadFilesFromInput(event) {
            event.preventDefault();
            const files = document.getElementById('fileInput').files;
            uploadFiles(files, currentPath);
        }


        async function saveNote(filePath, note) {
            await fetch('/save-note', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: filePath, note: note })
            });
        }

        function logout() {
            fetch('/logout')
                .then(() => window.location.href = '/login')
                .catch(err => console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', err));
        }

        document.addEventListener("dragend", () => dragIndicator.style.display = "none");
        document.addEventListener("dragover", (event) => {
            dragIndicator.style.left = `${event.pageX+10}px`;
            dragIndicator.style.top = `${event.pageY+10}px`;
        });

        fetchConfig();
    </script>
</body>
</html>
