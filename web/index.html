<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        .folder { font-weight: bold; cursor: pointer; }
        .back-btn, .download-btn { margin-bottom: 10px; }
        #drop-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>–§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</h1>
    <button class="back-btn" onclick="goUp()">‚¨Ü –ù–∞–∑–∞–¥</button>
    <button class="download-btn" onclick="downloadFiles()">‚¨á –°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    
    <div id="drop-area" ondrop="handleDrop(event)" ondragover="event.preventDefault()">
        –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
    </div>

    <form id="uploadForm" onsubmit="uploadFilesFromInput(event)" style="margin-bottom: 10px;" >
        –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
        <br>
        <input type="file" id="fileInput" multiple required>
        <button type="submit">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã</button>
    </form>
    <p id="uploadStatus"></p>

    <h3>        <span id="current-dir-name">/</span>   </h3>


    <button class="create-folder-btn" onclick="createFolder()">üìÅ –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
    <button class="delete-btn" onclick="deleteFiles()">üóë –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>


    <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫">
    <button onclick="searchFiles()">üîç</button>
    
    <table>
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all"></th>
                <th>–ò–º—è</th>
                <th>–†–∞–∑–º–µ—Ä</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</th>
                <th>–ó–∞–º–µ—Ç–∫–∏</th>
            </tr>
        </thead>
        <tbody id="file-list"></tbody>
    </table>
    <script>
        let currentPath = "";

        async function fetchFiles(path = 'uploads/') {
            currentPath = path;

            document.getElementById("current-dir-name").textContent = path || "/";
            const response = await fetch(`/files?path=${encodeURIComponent(path)}`);
            const data = await response.json();
            
            const fileList = document.getElementById("file-list");
            fileList.innerHTML = "";
            
            data.files.forEach(file => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td><input type="checkbox" value="${file.path}"></td>
                    <td class="${file.is_dir ? 'folder' : ''}" onclick="${file.is_dir ? `fetchFiles('${file.path}')` : ''}">
                        ${file.is_dir ? 'üìÅ' : 'üìÑ'} ${file.name}
                    </td>
                    <td>${file.size}</td>
                    <td>${file.modified}</td>
                    <td contenteditable="true" onblur="saveNote('${file.path}', this.innerText)">${file.notes || ''}</td>
                `;
                fileList.appendChild(row);
            });
        }
        
        function goUp() {
            if (!currentPath) return;
            const parentPath = currentPath.split("/").slice(0, -1).join("/");
            fetchFiles(parentPath)
        }
        
        async function downloadFiles() {
            const selectedFiles = Array.from(document.querySelectorAll("input[type='checkbox']:checked"))
                                      .map(cb => cb.value);
            if (selectedFiles.length === 0) return;
            
            const response = await fetch('/download-zip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: selectedFiles, currentDirName : currentPath })
            });
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = response.headers.get('Content-Disposition').split('filename=')[1];
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function deleteFiles() {
            const selectedFiles = Array.from(document.querySelectorAll("input[type='checkbox']:checked"))
                                      .map(cb => cb.value);
            if (selectedFiles.length === 0) return;
            
            const response = await fetch('/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: selectedFiles })
            });
            
            if (response.ok) {
                fetchFiles(currentPath);
            }
        }

        async function createFolder(path= "") {
            path = currentPath;
            const response = await fetch('/create-folder?path=' + encodeURIComponent(path), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path })
            });
            
            if (response.ok) {
                fetchFiles(currentPath);
            }
            
        }
        
        function handleDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            uploadFiles(files, currentPath);
        }
        
        async function uploadFiles(files, path = "") {
            path = currentPath;
            const formData = new FormData();
            formData.append('path', path);
            
            const filesArray = Array.from(files);
            for (let file of filesArray) {
                formData.append('files', file);
            }

            
            const response = await fetch('/upload?path=' + encodeURIComponent(path), {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                fetchFiles(path);
            }
        }

        async function uploadFilesFromInput(event) {
            event.preventDefault();
            const files = document.getElementById('fileInput').files;
            uploadFiles(files, currentPath);
        }


        async function saveNote(filePath, note) {
            await fetch('/save-note', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: filePath, note: note })
            });
        }
        
        fetchFiles();
    </script>
</body>
</html>
